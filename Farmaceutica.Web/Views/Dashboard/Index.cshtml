@using System.Security.Claims
@* LÍNEA 2 - CAMBIA ESTO *@
@model Farmaceutica.Core.DTOs.DashboardFullDto
@{
    // Obtener datos del usuario desde Claims
    var usuId = User.FindFirst("UsuarioId")?.Value ?? "0";
    var usuNom = User.Identity?.Name?.Split(' ')[0] ?? "Usuario";
    var usuApe = User.Identity?.Name?.Split(' ').Length > 1 ? User.Identity?.Name?.Split(' ')[1] : "";
    var usuImg = User.FindFirst("UsuarioImg")?.Value ?? "user.png";
    var usuRol = User.FindFirst(ClaimTypes.Role)?.Value ?? "Cliente";
}

@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
}

<!-- start page title -->
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">Dashboard</h4>

            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboards</a></li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </div>

        </div>
    </div>
</div>
<!-- end page title -->

<div class="row">
    <div class="col">
        <div class="h-100">
            <div class="row mb-3 pb-1">
                <div class="col-12">
                    <div class="d-flex align-items-lg-center flex-lg-row flex-column">
                        <div class="flex-grow-1">
                            <h4 class="fs-16 mb-1">Buenos dias, @usuNom @usuApe!</h4>
                            <p class="text-muted mb-0">Aquí encontrarás un resumen completo de tus métricas clave y tendencias actuales. <br />  Utiliza los filtros y herramientas disponibles para personalizar tu vista y acceder a la información más relevante para tus objetivos..</p>
                        </div>
                        <div class="mt-3 mt-lg-0">
                            <form action="javascript:void(0);">
                                <div class="row g-3 mb-0 align-items-center">
                                    <div class="col-auto">
                                        <a href="@Url.Action("Index", "Producto")"  class="btn btn-soft-success"><i class="ri-add-circle-line align-middle me-1"></i> Nuevo Producto</a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TARJETAS DEL DASHBOARD -->
            <div class="row">
                <!-- TARJETA 1: PRODUCTOS -->
                <div class="col-xl-3 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 overflow-hidden">
                                    <p class="text-uppercase fw-medium text-muted mb-0">
                                        @Model.Productos.Titulo
                                    </p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="fs-14 mb-0">
                                        <i class="@Model.Productos.IconoPorcentaje text-@Model.Productos.ColorPorcentaje"></i>
                                        <span class="text-@Model.Productos.ColorPorcentaje">
                                            @Model.Productos.PorcentajeCambio.ToString("N2")
                                        </span> %
                                    </h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold mb-4">
                                        @Model.Productos.Valor.ToString("N1")k
                                    </h4>
                                    <a href="@Url.Action("Index", "Producto")" class="text-decoration-underline">
                                        Ver detalle
                                    </a>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-soft-success rounded fs-3">
                                        <i class="bx bx-package text-success"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TARJETA 2: COMPRAS -->
                <div class="col-xl-3 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 overflow-hidden">
                                    <p class="text-uppercase fw-medium text-muted mb-0">
                                        @Model.Compras.Titulo
                                    </p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="fs-14 mb-0">
                                        <i class="@Model.Compras.IconoPorcentaje text-@Model.Compras.ColorPorcentaje"></i>
                                        <span class="text-@Model.Compras.ColorPorcentaje">
                                            @Model.Compras.PorcentajeCambio.ToString("N2")
                                        </span> %
                                    </h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold mb-4">
                                        @Model.Compras.Valor.ToString("N0")
                                    </h4>
                                    <a href="@Url.Action("Compras", "Compra")" class="text-decoration-underline">
                                        Ver detalle
                                    </a>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-soft-info rounded fs-3">
                                        <i class="bx bx-shopping-bag text-info"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TARJETA 3: VENTAS -->
                <div class="col-xl-3 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 overflow-hidden">
                                    <p class="text-uppercase fw-medium text-muted mb-0">
                                        @Model.Ventas.Titulo
                                    </p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="fs-14 mb-0">
                                        <i class="@Model.Ventas.IconoPorcentaje text-@Model.Ventas.ColorPorcentaje"></i>
                                        <span class="text-@Model.Ventas.ColorPorcentaje">
                                            @Model.Ventas.PorcentajeCambio.ToString("N2")
                                        </span> %
                                    </h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold mb-4">
                                        $@Model.Ventas.Valor.ToString("N1")k
                                    </h4>
                                    <a href="@Url.Action("Ventas", "Venta")" class="text-decoration-underline">
                                        Ver detalle
                                    </a>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-soft-warning rounded fs-3">
                                        <i class="bx bx-dollar-circle text-warning"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TARJETA 4: PEDIDOS -->
                <div class="col-xl-3 col-md-6">
                    <div class="card card-animate">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 overflow-hidden">
                                    <p class="text-uppercase fw-medium text-muted mb-0">
                                        @Model.Pedidos.Titulo
                                    </p>
                                </div>
                                <div class="flex-shrink-0">
                                    <h5 class="fs-14 mb-0">
                                        <i class="@Model.Pedidos.IconoPorcentaje text-@Model.Pedidos.ColorPorcentaje"></i>
                                        <span class="text-@Model.Pedidos.ColorPorcentaje">
                                            @Model.Pedidos.PorcentajeCambio.ToString("N2")
                                        </span> %
                                    </h5>
                                </div>
                            </div>
                            <div class="d-flex align-items-end justify-content-between mt-4">
                                <div>
                                    <h4 class="fs-22 fw-semibold mb-4">
                                        $@Model.Pedidos.Valor.ToString("N1")k
                                    </h4>
                                    <a href="@Url.Action("VentasDelivery", "Delivery")" class="text-decoration-underline">
                                        Ver detalle
                                    </a>
                                </div>
                                <div class="avatar-sm flex-shrink-0">
                                    <span class="avatar-title bg-soft-primary rounded fs-3">
                                        <i class="bx bx-cart text-primary"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- FIN TARJETAS -->
           
            @if (ViewBag.AnalisisEmpresa != null)
            {
                @await Html.PartialAsync("_AnalisisEmpresaPartial", (object)ViewBag.AnalisisEmpresa)
            }
            else
            {
                <div class="alert alert-info">
                    <i class="ri-information-line me-1"></i>
                    <a href="@Url.Action("Index", "AnalisisEmpresa")" class="alert-link">
                        Ver análisis completo de la empresa
                    </a>
                </div>
            }

            <div class="row">
                <div class="col-xl-6">
                    <div class="card">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Productos Mas Vendidos</h4>
                        </div><!-- end card header -->

                        <div class="card-body">
                            <div class="table-responsive table-card">
                                <table id="table_dataProductos" class="table table-bordered dt-responsive nowrap table-striped align-middle tabla-borde" style="width:100%; display:none;">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>NombreProducto</th>
                                            <th>Precio</th>
                                            <th>Stock</th>
                                            <th>VecesVendido</th>
                                            <th>FechaCreacion</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-6">
                    <div class="card card-height-100">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Productos Mas Comprados</h4>
                        </div><!-- end card header -->
                        <div class="card-body">
                            <div class="table-responsive table-card">
                                <table id="table_dataVentas" class="table table-bordered dt-responsive nowrap table-striped align-middle tabla-borde" style="width:100%; display:none;">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Producto</th>
                                            <th>Categoria</th>
                                            <th>Cliente</th>
                                            <th>Total</th>
                                            <th>Precio</th>
                                            <th>Cantidad</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div> <!-- .card-body-->
                    </div> <!-- .card-->
                </div> <!-- .col-->
            </div> <!-- end row-->

            <div class="row">
                <div class="col-xl-12">
                    <div class="card">
                        <div class="card-header align-items-center d-flex">
                            <h4 class="card-title mb-0 flex-grow-1">Ordenes Recientes</h4>
                        </div><!-- end card header -->

                        <div class="card-body">
                            <div class="table-responsive table-card">
                                <table id="table_dataPedidos" class="table table-bordered dt-responsive nowrap table-striped align-middle tabla-borde" style="width:100%; display:none;">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Producto</th>
                                            <th>Categoria</th>
                                            <th>Cliente</th>
                                            <th>Direccion</th>
                                            <th>Tlf Cliente</th>
                                            <th>Total</th>
                                            <th>Precio</th>
                                            <th>Cantidad</th>
                                            <th>Estado</th>
                                            <th>Tlf Delivery</th>
                                            <th>Delivery</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div> <!-- .card-->
                </div> <!-- .col-->
            </div> <!-- end row-->

        </div> <!-- end .h-100-->
    </div> <!-- end col -->
</div>

@section Scripts {
    <script src="~/js/home.js"></script>
}